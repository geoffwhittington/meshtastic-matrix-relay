services:
  mmrelay:
    build: .
    container_name: meshtastic-matrix-relay
    restart: unless-stopped
    user: "${UID:-1000}:${GID:-1000}"

    environment:
      - TZ=UTC
      - PYTHONUNBUFFERED=1
      - MPLCONFIGDIR=/tmp/matplotlib

    volumes:
      # Configuration - uses standard ~/.mmrelay/config.yaml location
      # Create this first with: make config
      - ${MMRELAY_HOME}/.mmrelay/config.yaml:/app/config.yaml:ro

      # Map entire ~/.mmrelay directory to /app/data to maintain proper structure
      # This includes plugins/, data/, logs/, and any other subdirectories
      # The --data-dir parameter in CMD points to /app/data
      - ${MMRELAY_HOME}/.mmrelay:/app/data

    # For TCP connections (most common) - Meshtastic typically uses port 4403
    ports:
      - 4403:4403

    # For serial connections, uncomment the device you need:
    # devices:
    #   - /dev/ttyUSB0:/dev/ttyUSB0
    #   - /dev/ttyACM0:/dev/ttyACM0

    # For BLE connections, uncomment these:
    # privileged: true
    # network_mode: host
    # Additional volumes for BLE (add to existing volumes section above):
    #   - /var/run/dbus:/var/run/dbus:ro
    #   - /sys/bus/usb:/sys/bus/usb:ro
    #   - /sys/class/bluetooth:/sys/class/bluetooth:ro
    #   - /sys/devices:/sys/devices:ro
